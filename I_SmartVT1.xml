<?xml version="1.0"?>
<implementation>
	<functions>
		-- Smart Virtual Thermostat v1.0c
        
        local TEMP_SID =    "urn:upnp-org:serviceId:TemperatureSensor1"
        local HVOS_SID =    "urn:micasaverde-com:serviceId:HVAC_OperatingState1"
        local TSH_SID =     "urn:upnp-org:serviceId:TemperatureSetpoint1_Heat"
        local TSC_SID =     "urn:upnp-org:serviceId:TemperatureSetpoint1_Cool"
        local HVUOM_SID =   "urn:upnp-org:serviceId:HVAC_UserOperatingMode1"
        local SVT_SID =     "urn:micasaverde-com:serviceId:SmartVT1"
        

		local DELAY = 10 -- Seconds
		local DEFAULT_HEAT_SP = 21
		local DEFAULT_COOL_SP = 18
		local DEFAULT_HG_SP = 8
		local MAX_TEMP = 40
		local MIN_TEMP = 0
		local STEP = 1
		local constC = 0.6
		local constT = 0.01
		local Tint
		local Text = -8
		local power
		local ID_EVAN_TEMP = 61
		local interval
		local h_temp
		local min_temp
        
        
		function virtual_thermostat_startup (lul_device)
            luup.log ("Virtual thermostat running...")
            local data = readSettings(lul_device)
            updateStatus(60)
		end
        
        function readSettings(lul_device)
        local data = {}
        
            -- Config ID
            data.InSensors = toListOfNumbers(readVariableOrInit(lul_device,SVT_SID, "Inside Temp Sensors", "" ))
            data.OutSensors = toListOfNumbers(readVariableOrInit(lul_device,SVT_SID, "Outside Temp Sensors", "" ))
            data.inhibitSensors = toListOfNumbers(readVariableOrInit(lul_device,SVT_SID, "inhibit Sensors", "" ))
            data.heaters = toListOfNumbers(readVariableOrInit(lul_device,SVT_SID, "heaters", "" ))
        
            -- Config Variables
            data.OpenTempo = tonumber(readVariableOrInit(lul_device,SVT_SID, "Waiting Time Open", "0" ))
            data.CloseTempo = tonumber(readVariableOrInit(lul_device,SVT_SID, "Waiting Time Close", "0" ))
            data.ForcedTempo = tonumber(readVariableOrInit(lul_device,SVT_SID, "Forced Mode Duration", "1200" ))
        
            data.heatSp = tonumber(readVariableOrInit(lul_device,TSH_SID, "CurrentSetpoint", DEFAULT_HEAT_SP ))
            data.coolSp = tonumber(readVariableOrInit(lul_device,TSC_SID, "CurrentSetpoint", DEFAULT_COOL_SP )) 
        
            -- internal Variables
            data.ForcedModeState = readVariableOrInit(lul_device,SVT_SID, "Forced Mode", "0" )
        
            return data
        end
		
		
--		function increaseTemp (heatSp)
--			local currentTemperature = luup.variable_get (TEMP_SID, "CurrentTemperature", 61)
--			currentTemperature = tonumber (currentTemperature, 10) + STEP
--			heatSp = tonumber (heatSp, 10)
--			local target = heatSp or MAX_TEMP
--			if (currentTemperature &lt;= target) then
--				luup.variable_set(TEMP_SID, "CurrentTemperature", tostring (currentTemperature), lul_device)
--				if (currentTemperature &lt; target) then
--					luup.call_delay ("increaseTemp", DELAY, tostring (heatSp))
--				else
--					luup.variable_set (HVOS_SID, "ModeState", "Idle", lul_device)
--				end
--			end
--		end


--		function decreaseTemp (coolSp)
--			local currentTemperature = luup.variable_get (TEMP_SID, "CurrentTemperature", 61)
--			currentTemperature = tonumber (currentTemperature, 10) - STEP
--			coolSp = tonumber (coolSp, 10)
--			local target = coolSp or MIN_TEMP
--			if (currentTemperature &gt;= target) then
--				luup.variable_set (TEMP_SID, "CurrentTemperature", tostring (currentTemperature), lul_device)
--				if (currentTemperature &gt; target) then
--					luup.call_delay ("decreaseTemp", DELAY, tostring (coolSp))
--				else
--					luup.variable_set (HVOS_SID, "ModeState", "Idle", lul_device)
--				end
--			end
--		end
        
        
        function AvgTemperature(t)
            local sum = 0
            local count= 0
            local temp = {}
            for k,id in pairs(t) do
                local temp = luup.variable_get (TEMP_SID, "CurrentTemperature", id)
                if type(temp) == 'number' then
                    sum = sum + temp
                    count = count + 1
                end
            end
        
            if count>1 then
                return round((sum / count),1)
            else
                return nil
            end
        
        end
        
		function updateStatus(interval)
            local data = readSettings(lul_device)
        
            -- check data before process
            if (data.InSensors == nill or #data.InSensors &gt; 1 and data.heaters == nill or #data.heaters &gt; 1) then return nill
        
			local heatSp = data.heatSp
			local coolSp = data.coolSp
			local modeStatus = luup.variable_get (HVUOM_SID, "ModeStatus", lul_device)
			Tint = AvgTemperature(data.InSensors)
			luup.log("La temperature venant du l'ID " .. ID_EVAN_TEMP .. " est de " .. Tint .. "DEGC")
			luup.variable_set (TEMP_SID, "CurrentTemperature", Tint, lul_device)
--			if (modeStatus == "HeatOn") then
--				luup.variable_set (HVOS_SID, "ModeState", "Heating", lul_device)
--				if (not currentTemperature) then
--					currentTemperature = math.random (MIN_TEMP, DEFAULT_HEAT_SP - 1)
--					luup.log("CurrentTemp modifiee par HeatOn")
--				end
			--	luup.call_delay ("increaseTemp", DELAY, "")
--			elseif (modeStatus == "CoolOn") then
--				luup.variable_set (HVOS_SID, "ModeState", "Cooling", lul_device)
--				if (not currentTemperature) then
--					currentTemperature = math.random (DEFAULT_COOL_SP + 1, MAX_TEMP)
--					luup.log("CurrentTemp modifiee par CoolOn")
--				end
			--	luup.call_delay ("decreaseTemp", DELAY, "")
			if (modeStatus == "AutoChangeOver") then
				--if (not currentTemperature) then
				--	currentTemperature = math.random (MIN_TEMP + 1, MAX_TEMP - 1)
				--	luup.log("CurrentTemp modifiee par Autochangeover")
				--	luup.variable_set (TEMP_SID, "CurrentTemperature", tostring (currentTemperature), lul_device)
				--end
				power = ((heatSp - tonumber(Tint)) * constC + (heatSp - Text) * constT) * 100
				if (power &lt; 0) then power = 0 end
				if (power &gt; 100) then power = 100 end
				local tpschauf = power * 36 / 60
				tpschauf = math.floor(tpschauf)
				local hchauf = os.date("*t")
				min_temp = hchauf.min + tpschauf
				if (min_temp &gt; 59) then
					min_temp = min_temp - 60
					h_temp = 1
				else
					h_temp = 0
				end	
				local hchauf1 = hchauf.hour * 100 + hchauf.min
				local harret = (hchauf.hour + h_temp) * 100 + min_temp
--				local harret = tonumber(hchauf) + tpschauf
				luup.log("La puissance calculee est de : " .. power .. "% et le temps de chauffe est de : " .. tpschauf .. " minutes sur une heure")
				luup.log("Puissance calculee a: " .. hchauf1 .. ". Le chauffage s'arretera a : " .. harret)
					luup.variable_set (HVOS_SID, "ModeState", "Heating", lul_device)
				--	luup.call_delay ("increaseTemp", DELAY, tostring (heatSp))
				--elseif (currentTemperature &gt; coolSp) then
				--	luup.variable_set (HVOS_SID, "ModeState", "Cooling", lul_device)
				--	luup.call_delay ("decreaseTemp", DELAY, tostring (coolSp))
				--else
				--	luup.variable_set (HVOS_SID, "ModeState", "Idle", lul_device)
				--end
			else
				luup.variable_set (HVUOM_SID, "ModeStatus", "Off", lul_device)
				luup.variable_set (HVOS_SID, "ModeState", "Idle", lul_device)
				power = 0
				luup.log("La puissance de chauffe est de: " .. power)
--				if (not currentTemperature) then
--					currentTemperature = math.random (MIN_TEMP + 1, MAX_TEMP - 1)
--					luup.log("CurrentTemp modifiee par ELSE derniere etape")
--					luup.variable_set (TEMP_SID, "CurrentTemperature", tostring (currentTemperature), lul_device)
--				end
			end
			luup.call_timer("updateStatus", 1, interval, "", interval)
		end



	</functions>
	<startup>virtual_thermostat_startup</startup>
    <files>L_SmartVT1.lua</files>
	<actionList>
		<action>
			<serviceId>urn:upnp-org:serviceId:HVAC_UserOperatingMode1</serviceId>
			<name>SetModeTarget</name>
			<job>
				luup.variable_set (HVUOM_SID, "ModeTarget", lul_settings.NewModeTarget, lul_device)
				luup.variable_set (HVUOM_SID, "ModeStatus", lul_settings.NewModeTarget, lul_device)
				updateStatus(60)
				return 4, 5
			</job>
		</action>
		<action>
			<serviceId>urn:upnp-org:serviceId:TemperatureSetpoint1_Heat</serviceId>
			<name>SetCurrentSetpoint</name>
			<job>
				luup.variable_set (TSH_SID, "CurrentSetpoint", lul_settings.NewCurrentSetpoint, lul_device)
				updateStatus(60)
				return 4, 5
			</job>
		</action>
		<action>
			<serviceId>urn:upnp-org:serviceId:TemperatureSetpoint1_Cool</serviceId>
			<name>SetCurrentSetpoint</name>
			<job>
				luup.variable_set (TSC_SID, "CurrentSetpoint", lul_settings.NewCurrentSetpoint, lul_device)
				updateStatus(60)
				return 4, 5
			</job>
		</action>
		<action>
			<serviceId>urn:upnp-org:serviceId:SwitchPower1</serviceId>
			<name>SetTarget</name>
			<job>
				luup.variable_set ("urn:upnp-org:serviceId:SwitchPower1", "Target", lul_settings.newTargetValue, lul_device)
				luup.variable_set ("urn:upnp-org:serviceId:SwitchPower1", "Status", lul_settings.newTargetValue, lul_device)
				return 4, 5
			</job>
		</action>
	</actionList>
</implementation>
